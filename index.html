<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Rhythm - Final Version</title>
    <style>
        body { 
            background: radial-gradient(circle, #001233 0%, #000000 100%); 
            color: white; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; 
        }
        #ui-container { position: absolute; top: 20px; text-align: center; z-index: 10; pointer-events: none; }
        canvas { 
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.2); 
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            background: #000;
        }
        button {
            position: absolute; padding: 15px 40px; font-size: 20px; background: rgba(0,0,0,0.8); 
            color: #00f2ff; border: 2px solid #00f2ff; cursor: pointer; z-index: 20;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 3px; font-weight: bold;
        }
        button:hover { background: #00f2ff; color: black; box-shadow: 0 0 30px #00f2ff; }
        button:disabled { border-color: #555; color: #555; cursor: wait; }
    </style>
</head>
<body>

<div id="ui-container">
    <h1 style="margin:0; letter-spacing: 5px; color: #00f2ff; text-shadow: 0 0 10px #00f2ff;">VELOCITY PLAY</h1>
    <p id="scoreText" style="font-size: 24px; margin: 5px 0;">SCORE: 000000</p>
</div>
<button id="startBtn">LOADING MUSIC...</button>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * [전체 코드] - 리듬게임 엔진 & 오디오 통합본
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const scoreText = document.getElementById('scoreText');

canvas.width = 500;
canvas.height = 700;

// 설정값
const KEYS = ['a', 's', 'd', 'f'];
const COLORS = ['#FF007A', '#00f2ff', '#00f2ff', '#FFFFFF'];
const COLUMN_WIDTH = canvas.width / 4;
const JUDGMENT_LINE_Y = 600;
const NOTE_SPEED = 600;

let notes = [];
let score = 0;
let startTime = 0;
let isPlaying = false;
let lastJudgement = "";
let judgementColor = "#fff";
let judgementOpacity = 0;

// 오디오 초기화
const gameAudio = new Audio('music.mp3');
startBtn.disabled = true;

// 음악 파일 로드 확인
gameAudio.addEventListener('canplaythrough', () => {
    startBtn.disabled = false;
    startBtn.innerText = "START MISSION";
    console.log("Music is ready!");
});

gameAudio.addEventListener('error', () => {
    startBtn.innerText = "FILE NOT FOUND";
    console.error("music.mp3 파일을 찾을 수 없습니다.");
});

// MIDI 기반 노트 데이터 (사용자 제공)
const midiData = [
    { time: 0.50, lane: 0 }, { time: 0.75, lane: 2 }, { time: 1.10, lane: 1 }, { time: 1.40, lane: 3 },
    { time: 1.80, lane: 0 }, { time: 2.10, lane: 2 }, { time: 2.30, lane: 1 }, { time: 2.55, lane: 3 },
    { time: 3.00, lane: 0 }, { time: 3.25, lane: 1 }, { time: 3.50, lane: 2 }, { time: 3.80, lane: 0 },
    { time: 4.20, lane: 3 }, { time: 4.50, lane: 1 }, { time: 4.85, lane: 2 }, { time: 5.20, lane: 0 },
    { time: 5.60, lane: 3 }, { time: 6.00, lane: 1 }, { time: 6.30, lane: 2 }, { time: 6.70, lane: 0 }
];

const keyState = { a: false, s: false, d: false, f: false };

// 입력 처리
window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    if (KEYS.includes(key)) {
        keyState[key] = true;
        checkHit(KEYS.indexOf(key));
    }
});

window.addEventListener('keyup', (e) => {
    const key = e.key.toLowerCase();
    if (KEYS.includes(key)) keyState[key] = false;
});

function checkHit(lane) {
    if (!isPlaying) return;
    const currentTime = (performance.now() - startTime) / 1000;
    
    for (let note of notes) {
        if (note.lane === lane && !note.hit) {
            const diff = Math.abs(currentTime - note.time);
            if (diff < 0.20) {
                note.hit = true;
                if (diff < 0.06) { showJudgement("PERFECT", "#00f2ff"); score += 1000; }
                else if (diff < 0.11) { showJudgement("GREAT", "#00ff00"); score += 700; }
                else if (diff < 0.16) { showJudgement("GOOD", "#ffff00"); score += 400; }
                else { showJudgement("BAD", "#ff0000"); score += 100; }
                updateScore();
                break;
            }
        }
    }
}

function showJudgement(text, color) {
    lastJudgement = text;
    judgementColor = color;
    judgementOpacity = 1.0;
}

function updateScore() {
    scoreText.innerText = `SCORE: ${score.toString().padStart(6, '0')}`;
}

function drawGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 그리드
    ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
    for(let i=0; i<=4; i++) {
        ctx.beginPath(); ctx.moveTo(i * COLUMN_WIDTH, 0); ctx.lineTo(i * COLUMN_WIDTH, canvas.height); ctx.stroke();
    }

    // 판정 텍스트
    if (judgementOpacity > 0) {
        ctx.save();
        ctx.globalAlpha = judgementOpacity;
        ctx.font = "bold 50px Arial";
        ctx.fillStyle = judgementColor;
        ctx.textAlign = "center";
        ctx.shadowBlur = 20; ctx.shadowColor = judgementColor;
        ctx.fillText(lastJudgement, canvas.width / 2, 350);
        ctx.restore();
        judgementOpacity -= 0.03;
    }

    // 판정 라인
    for(let i=0; i<4; i++) {
        const x = i * COLUMN_WIDTH + COLUMN_WIDTH / 2;
        ctx.strokeStyle = keyState[KEYS[i]] ? COLORS[i] : 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(x, JUDGMENT_LINE_Y, 40, 0, Math.PI * 2); ctx.stroke();
        if(keyState[KEYS[i]]) {
            ctx.fillStyle = COLORS[i] + '66'; ctx.fill();
        }
    }
}

function update() {
    if (!isPlaying) return;
    const currentTime = (performance.now() - startTime) / 1000;

    drawGame();

    notes.forEach(note => {
        if (!note.hit) {
            const relativeTime = note.time - currentTime;
            const y = JUDGMENT_LINE_Y - (relativeTime * NOTE_SPEED);

            if (y > -50 && y < canvas.height + 50) {
                ctx.shadowBlur = 20; ctx.shadowColor = COLORS[note.lane];
                ctx.fillStyle = COLORS[note.lane];
                ctx.fillRect(note.lane * COLUMN_WIDTH + 15, y - 8, COLUMN_WIDTH - 30, 16);
                ctx.shadowBlur = 0;
            }
            
            if (y > JUDGMENT_LINE_Y + 100) {
                note.hit = true;
                showJudgement("MISS", "#555555");
            }
        }
    });

    requestAnimationFrame(update);
}

startBtn.addEventListener('click', () => {
    // 오디오 재생 시도
    gameAudio.play().then(() => {
        notes = midiData.map(n => ({ ...n, hit: false }));
        score = 0;
        updateScore();
        startTime = performance.now();
        isPlaying = true;
        startBtn.style.display = 'none';
        update();
    }).catch(e => {
        alert("재생 오류: music.mp3 파일이 같은 폴더에 있는지 확인하세요.");
        console.error(e);
    });
});
</script>
</body>
</html>
