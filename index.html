<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dubai Cookie - Sound Fix Version</title>
    <style>
        body { 
            background: radial-gradient(circle, #2c1e12 0%, #000000 100%); 
            color: white; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; 
        }
        #ui-container { position: absolute; top: 20px; text-align: center; z-index: 10; pointer-events: none; }
        canvas { 
            box-shadow: 0 0 50px rgba(255, 184, 0, 0.2); 
            border-left: 2px solid rgba(255, 215, 0, 0.1);
            border-right: 2px solid rgba(255, 215, 0, 0.1);
            background: #000;
        }
        .control-panel { position: absolute; z-index: 20; text-align: center; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; border: 2px solid #ffd700; }
        button {
            padding: 15px 40px; font-size: 20px; background: #8b4513; 
            color: #ffd700; border: 2px solid #ffd700; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; margin-top: 10px;
        }
        button:hover { background: #ffd700; color: black; box-shadow: 0 0 30px #ffd700; }
        #status { margin-bottom: 15px; color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui-container">
    <h1 style="margin:0; letter-spacing: 3px; color: #ffd700; text-shadow: 0 0 10px #8b4513;">DUBAI COOKIE RHYTHM</h1>
    <p id="scoreText" style="font-size: 24px; margin: 5px 0;">SCORE: 000000</p>
    <p id="comboText" style="font-size: 18px; color: #ff007a;">COMBO: 0</p>
</div>

<div class="control-panel" id="startMenu">
    <div id="status">음악을 불러오는 중...</div>
    <button id="startBtn" style="display:none;">START MISSION</button>
    <p style="font-size: 12px; color: #aaa; margin-top: 10px;">(주의: music.mp3 파일이 같은 폴더에 있어야 합니다)</p>
</div>

<canvas id="gameCanvas"></canvas>

<audio id="bgm" src="music.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const startMenu = document.getElementById('startMenu');
const statusText = document.getElementById('status');
const bgm = document.getElementById('bgm');
const scoreText = document.getElementById('scoreText');
const comboText = document.getElementById('comboText');

canvas.width = 500;
canvas.height = 700;

// 설정 및 데이터
const KEYS = ['a', 's', 'd', 'f'];
const COLORS = ['#ff007a', '#ffd700', '#ffd700', '#ffffff'];
const COLUMN_WIDTH = canvas.width / 4;
const JUDGMENT_LINE_Y = 600;
const NOTE_SPEED = 650; 

let notes = [];
let score = 0;
let combo = 0;
let startTime = 0;
let isPlaying = false;
let lastJudgement = "";
let judgementColor = "#fff";
let judgementOpacity = 0;

[cite_start]// MIDI 기반 채보 데이터 [cite: 1]
const dubaiNotes = [
    { time: 0.5, lane: 0 }, { time: 0.8, lane: 2 }, { time: 1.1, lane: 1 }, { time: 1.4, lane: 3 },
    { time: 1.8, lane: 0 }, { time: 2.1, lane: 2 }, { time: 2.3, lane: 1 }, { time: 2.5, lane: 3 },
    { time: 3.0, lane: 0 }, { time: 3.2, lane: 1 }, { time: 3.5, lane: 2 }, { time: 3.8, lane: 0 }
];

// 음악 로드 체크
bgm.oncanplaythrough = () => {
    statusText.innerText = "음악 준비 완료!";
    startBtn.style.display = "inline-block";
};

bgm.onerror = () => {
    statusText.innerText = "파일(music.mp3)을 찾을 수 없습니다.";
    statusText.style.color = "red";
};

const keyState = { a: false, s: false, d: false, f: false };

window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    if (KEYS.includes(key)) {
        keyState[key] = true;
        checkHit(KEYS.indexOf(key));
    }
});

window.addEventListener('keyup', (e) => {
    const key = e.key.toLowerCase();
    if (KEYS.includes(key)) keyState[key] = false;
});

function checkHit(lane) {
    if (!isPlaying) return;
    const currentTime = (performance.now() - startTime) / 1000;
    for (let note of notes) {
        if (note.lane === lane && !note.hit) {
            const diff = Math.abs(currentTime - note.time);
            if (diff < 0.20) {
                note.hit = true;
                if (diff < 0.07) { showJudgement("PERFECT", "#ffd700"); score += 1000; combo++; }
                else if (diff < 0.12) { showJudgement("GREAT", "#00ff00"); score += 700; combo++; }
                else { showJudgement("GOOD", "#ffff00"); score += 400; combo++; }
                updateUI();
                break;
            }
        }
    }
}

function showJudgement(text, color) {
    lastJudgement = text;
    judgementColor = color;
    judgementOpacity = 1.0;
}

function updateUI() {
    scoreText.innerText = `SCORE: ${score.toString().padStart(6, '0')}`;
    comboText.innerText = `COMBO: ${combo}`;
}

function update() {
    if (!isPlaying) return;
    const currentTime = (performance.now() - startTime) / 1000;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 배경선
    ctx.strokeStyle = 'rgba(255, 215, 0, 0.1)';
    for(let i=0; i<=4; i++) {
        ctx.beginPath(); ctx.moveTo(i * COLUMN_WIDTH, 0); ctx.lineTo(i * COLUMN_WIDTH, canvas.height); ctx.stroke();
    }

    // 판정 효과
    if (judgementOpacity > 0) {
        ctx.save();
        ctx.globalAlpha = judgementOpacity;
        ctx.font = "bold 50px Arial";
        ctx.fillStyle = judgementColor;
        ctx.textAlign = "center";
        ctx.shadowBlur = 20; ctx.shadowColor = judgementColor;
        ctx.fillText(lastJudgement, canvas.width / 2, 350);
        ctx.fillText(`${combo} COMBO`, canvas.width / 2, 410);
        ctx.restore();
        judgementOpacity -= 0.03;
    }

    // 판정선 구멍
    for(let i=0; i<4; i++) {
        const x = i * COLUMN_WIDTH + COLUMN_WIDTH / 2;
        ctx.strokeStyle = keyState[KEYS[i]] ? COLORS[i] : 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(x, JUDGMENT_LINE_Y, 40, 0, Math.PI * 2); ctx.stroke();
    }

    // 노트 이동
    notes.forEach(note => {
        if (!note.hit) {
            const relativeTime = note.time - currentTime;
            const y = JUDGMENT_LINE_Y - (relativeTime * NOTE_SPEED);
            if (y > -50 && y < canvas.height + 50) {
                ctx.fillStyle = COLORS[note.lane];
                ctx.fillRect(note.lane * COLUMN_WIDTH + 15, y - 10, COLUMN_WIDTH - 30, 20);
            }
            if (y > JUDGMENT_LINE_Y + 100) {
                note.hit = true; combo = 0;
                showJudgement("MISS", "#555555");
                updateUI();
            }
        }
    });

    requestAnimationFrame(update);
}

startBtn.onclick = () => {
    bgm.play().then(() => {
        notes = dubaiNotes.map(n => ({ ...n, hit: false }));
        score = 0; combo = 0;
        updateUI();
        startTime = performance.now();
        isPlaying = true;
        startMenu.style.display = 'none';
        update();
    }).catch(e => {
        alert("브라우저에서 음악 재생을 차단했습니다. 화면을 한 번 클릭한 뒤 다시 시작해주세요.");
    });
};
</script>
</body>
</html>
